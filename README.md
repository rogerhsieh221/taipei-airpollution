# Taipei PM2.5 & PM10 Prediction Project

本專案旨在預測台北市的 PM2.5 與 PM10 空氣品質指標。  
透過環境部 API 取得空品監測數據，經過資料清理、特徵工程與多種模型訓練後，選出最佳模型以供後續部署與視覺化應用。

👉 [🔗 線上預測網站 Demo (Streamlit）](https://taipei-airpollution-demo.streamlit.app/)

## 🌐 網站功能說明（Taipei Air Quality Forecast）

- 本網站為部署於 Streamlit Cloud 的互動式空氣品質預測平台，使用者可選擇台北市任一測站，輸入欲預測的日期與小時，即可即時獲得 PM2.5 與 PM10 的逐小時預測結果及視覺化分析。
- 雲端部署後的網址可直接供公眾存取，讓大家可以看到最終整合模型推論、資料視覺化與互動操作。

---

### 🔧 使用者互動流程

- **監測站點選擇**  
  使用者可於左側欄位選擇想要預測的監測站（如：大同、士林等）。

- **預測時間設定**  
  使用者可透過日期選擇器與滑桿選取「目標預測時間」。

- **開始預測**  
  點擊「Start Prediction」按鈕後，系統會根據目前最新觀測資料，使用訓練好的 ML 模型逐時預測至目標時間。

---

### 🧠 背後預測邏輯

- 使用三筆最近觀測的資料，建立 **滯後特徵**（如 lag1, lag2, roll3）與時間特徵（hour, dayofweek）。
- 依據特徵餵入已訓練好的：
  - PM2.5 預測模型 `model_pm25`
  - PM10 預測模型 `model_pm10`
- 模型預測一小時，並將結果回填至序列，再用來預測下一小時，以此遞推至目標時間。

---

### 📈 可視化結果

1. **歷史與預測趨勢圖（含 ±5% 信心區間）**
   - 顯示 PM2.5 與 PM10 的過去觀測與未來預測
   - 明顯區分預測起始時間點

2. **Heatmap 熱力圖**
   - 呈現每小時預測結果，依據不同日期畫出不同顏色的熱力分佈
   - 易於辨識空氣品質惡化的尖峰時段

3. **PM2.5 健康警示與色條**
   - 根據預測 PM2.5 數值給出健康建議（良好、普通、不良）
   - 以色彩呈現風險程度與數值

4. **預測結果表格**
   - 展示所有預測小時對應的 PM2.5 與 PM10 數值
   - 提供使用者詳細檢視與後續分析

---

## 📁 專案架構與流程

```
├── src/                 # 原始碼
│   ├── fetch_data.py      # 從 API 下載並整理資料
│   ├── preprocessed.py    # 資料前處理與特徵工程
│   └── train_model.py     # 訓練 PM2.5 模型
│   └── train_pm10_model.py# 訓練 PM10 模型
├── data/                # 原始與處理後資料
├── model/               # Scaler、模型與訓練報告
```

---

## 📡 資料來源

- **API Endpoint**:  
  `https://data.moenv.gov.tw/api/v2/aqx_p_136`

- **主要欄位**:
  | 欄位名稱       | 說明             |
  | -------------- | ---------------- |
  | sitename       | 測站名稱         |
  | monitordate    | 監測時間（字串） |
  | itemengname    | 監測項目名稱     |
  | concentration  | 濃度（字串需轉數值） |

> 將原始 JSON 轉為長格式 CSV：`data/taipei_long.csv`

---

## 🧹 資料前處理（`preprocessed.py`）

1. **格式轉換：長 → 寬格式**
```python
df = df.pivot_table(
    index=["sitename", "monitordate"],
    columns="itemengname",
    values="concentration"
).reset_index()
```

2. **時間處理與排序**
```python
df["datetime"] = pd.to_datetime(df["monitordate"])
df = df.sort_values("datetime")
```

3. **缺失值處理**
- 移除 PM2.5 或 PM10 缺失值
- 其他欄位：先 forward fill → 再以全域中位數補齊
```python
df = df.dropna(subset=["PM2.5", "PM10"])
df = df.fillna(method="ffill")
df = df.fillna(df.median(numeric_only=True))
```

4. **特徵工程（Feature Engineering）**

- 為了提升模型對時間序列中 PM2.5 和 PM10 變化趨勢的理解與預測能力，我們設計了以下幾類特徵：

---

#### 📌 滯後特徵簡介（What are Lag Features?）

- 在時間序列建模中，**滯後特徵（Lag Features）** 是指使用「前一個或多個時間點」的觀測值作為目前時間點的輸入特徵。這種方式能幫助模型捕捉時間上的延續性與趨勢，例如「昨天的空氣品質會影響今天的空氣品質」。

舉例來說：
- `lag1` 代表的是 t-1 時刻的觀測值，用於預測 t 時刻。
- `lag3` 則是 t-3 的值，用於了解三小時前的狀況對現在的影響。
- `roll3` 是前 3 小時的平均值，有助於平滑突變值，反映短期趨勢。

- 滯後特徵是許多時間序列預測模型（如 ARIMA、XGBoost、LSTM）中的基礎特徵類型。

---

#### 時間特徵（Temporal Features）
- `hour`：從時間戳中提取的「小時」資訊，幫助模型捕捉日內變化週期（例如通勤時段污染上升）。
- `dayofweek`：提取星期幾（0 = 星期一，6 = 星期日），捕捉一週中的變化規律，例如週末與平日的空氣品質差異。

```python
df["hour"] = df["datetime"].dt.hour
df["dayofweek"] = df["datetime"].dt.dayofweek
```

5. **標準化**
```python
scaler = StandardScaler()
df[feature_cols] = scaler.fit_transform(df[feature_cols])
joblib.dump(scaler, "model/scaler.pkl")
```

---

## 🎯 PM2.5 預測說明

### 使用特徵（共 23 項）
```python
[
  "AMB_TEMP", "CH4", "CO", "NMHC", "NO", "NO2", "NOx", "O3", "PM10",
  "RAINFALL", "RH", "SO2", "THC", "WD_HR", "WIND_DIREC", "WIND_SPEED", "WS_HR",
  "pm2.5_lag1", "pm2.5_lag2", "pm2.5_lag3", "pm2.5_roll3", "hour", "dayofweek"
]
```

- 目標變數：`PM2.5`

---

## 🎯 PM10 預測說明

本模組旨在預測 PM10 空氣污染指標，並使用與 PM2.5 模型類似的資料處理與特徵工程流程。

### 📥 使用特徵（共 23 項）

```python
[
  "AMB_TEMP", "CH4", "CO", "NMHC", "NO", "NO2", "NOx", "O3", "PM2.5",
  "RAINFALL", "RH", "SO2", "THC", "WD_HR", "WIND_DIREC", "WIND_SPEED", "WS_HR",
  "pm10_lag1", "pm10_lag2", "pm10_lag3", "pm10_roll3", "hour", "dayofweek"
]
```

- 目標變數：`PM10`

---

## 🤖 模型使用

| 模型             | 類型         | 說明                                 |
|------------------|--------------|--------------------------------------|
| Random Forest    | 集成模型     | 高效處理非線性特徵                   |
| XGBoost          | 強化集成     | 精準快速，適合時間序列變數           |
| LightGBM         | 強化集成     | 訓練快速，支援大量特徵               |
| SVR              | 支援向量機   | 擅長處理非線性與小樣本               |
| KNN              | 距離型模型   | 以鄰近歷史數據推測                   |
| ARIMA            | 時間序列模型 | 使用 AIC 選擇最佳 (p,d,q) 組合       |
| Markov Chain     | 機率模型     | 將污染值離散為狀態並預測轉移機率     |

---

## 🧭 `sitename` 的處理策略

- 所有模型皆 **不拆站點**，使用整個台北地區混合訓練資料。

| 方法         | 優點                         | 缺點                         |
|--------------|------------------------------|------------------------------|
| 不拆站點     | 訓練資料更多，模型更穩定     | 無法考慮個別站點特性         |
| 拆開訓練     | 精準反映地區差異             | 資料稀疏、容易 overfit       |

---

## 📊 模型評估指標

- MAE（Mean Absolute Error）  
- MSE（Mean Squared Error）  
- RMSE（Root Mean Squared Error）

每次訓練會儲存：
1. 模型比較報告（CSV）
2. 最佳模型（排除 inf 結果）儲存為 `.pkl`

---

## 📊 模型評估結果

### 🔹 LightGBM
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 0.64        | 0.39         | 2.42         | 1.43          |
| MSE          | 0.66        | 0.25         | 9.64         | 3.26          |
| RMSE         | 0.81        | 0.50         | 3.10         | 1.81          |

### 🔹 SVR
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 0.66        | 0.05         | 2.13         | 0.05          |
| MSE          | 0.76        | 0.00         | 7.56         | 0.00          |
| RMSE         | 0.87        | 0.05         | 2.75         | 0.05          |

### 🔹 XGBoost
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 0.72        | 0.00         | 2.03         | 0.00          |
| MSE          | 0.78        | 0.00         | 7.01         | 0.00          |
| RMSE         | 0.88        | 0.00         | 2.65         | 0.01          |

### 🔹 KNN
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 0.74        | 0.00         | 2.53         | 0.00          |
| MSE          | 0.90        | 0.00         | 9.57         | 0.00          |
| RMSE         | 0.95        | 0.00         | 3.09         | 0.00          |

### 🔹 Random Forest
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 0.76        | 0.24         | 2.10         | 0.88          |
| MSE          | 0.89        | 0.11         | 8.36         | 1.30          |
| RMSE         | 0.94        | 0.33         | 2.89         | 1.14          |

### 🔹 ARIMA
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 0.83        | 0.80         | inf          | inf           |
| MSE          | 0.97        | 1.06         | inf          | inf           |
| RMSE         | 0.99        | 1.03         | inf          | inf           |

### 🔹 Markov Chain
| 指標         | PM10 (Test) | PM10 (Train) | PM2.5 (Test) | PM2.5 (Train) |
|--------------|-------------|--------------|--------------|---------------|
| MAE          | 1.04        | 1.14         | 4.53         | 3.57          |
| MSE          | 1.62        | 2.06         | 28.63        | 20.76         |
| RMSE         | 1.27        | 1.43         | 5.35         | 4.56          |





## 🧪 執行流程範例

```bash
# PM2.5 預測流程
python src/fetch_data.py
python src/preprocessed.py
python src/train_model_pm25.py

# PM10 預測流程
python src/train_model_pm10.py
```

### 🔍 產出結果

| 輸出檔案                                      | 說明                             |
|-----------------------------------------------|----------------------------------|
| `data/processedXXXX.csv`                      | 清理與特徵工程後的資料           |
| `model/scaler.pkl` / `scaler_pm10.pkl`        | 特徵標準化器                     |
| `model/final_model_*.pkl`                     | 儲存最佳模型                     |
| `model/results/training_report_*.csv`         | 模型評估報告（按 MAE 排序）     |

---

## ⚠️ 資料與模型限制說明

### 📉 資料量不足與品質挑戰

- **觀測資料量偏少**：  
  雖然專案涵蓋多個監測站，但實際納入訓練的資料筆數有限，特別是在資料清理（缺值刪除與補齊）後，部分站點的有效樣本數大幅下降。這對模型訓練造成以下挑戰：
  - 難以捕捉長期趨勢與週期性
  - 模型容易 overfit 至少量樣本
  - 在少數極端天氣或污染事件下表現不穩

- **資料品質參差不齊**：  
  由於原始 API 提供的空氣品質資料來自即時監測，可能受限於儀器誤差、遺漏、或短時間內異常波動。我們觀察到：
  - 部分欄位如 CH4、NMHC 在特定時段有大量缺值
  - 同一時點不同測站的值差異大，無明顯地理邏輯
  - RAINFALL 等欄位出現異常集中於單一數值

---

### 🤔 模型表現仍有待提升

- 雖然使用了多種強化學習與時間序列模型（如 XGBoost、LightGBM、SVR 等），但整體預測誤差仍偏高，尤其是 PM2.5 的 RMSE 在測試集上普遍超過 **3**，部分模型甚至無法有效預測（如 ARIMA 為 inf）。
- 我們認為這與以下因素有關：
  - **特徵選擇受限**：缺乏地理資訊（如站點座標、交通密度）、天氣預報等外部輔助特徵。
  - **樣本不均衡**：污染濃度偏低的樣本占比過高，模型對高污染事件預測力不足。
  - **模型泛化能力弱**：訓練與測試集的時間段分布接近，導致過度擬合歷史特定時間特徵。

---

### 🔄 未來改進方向

1. **資料擴充**  
   - 結合歷年資料或多縣市監測數據，以提升樣本數與時間多樣性。
   - 加入氣象資料（如氣溫變化、風向預測、PM2.5 傳輸模型）。

2. **高品質特徵工程**  
   - 利用空間鄰近測站資訊（空間卷積）、污染物組合（如 O3 - NOx 平衡）等提升解釋力。
   - 採用自動特徵選擇與交叉驗證，減少冗餘特徵干擾模型判斷。

3. **進階模型嘗試**  
   - 導入時序深度學習模型（如 Transformer、Temporal Fusion Transformer）。
   - 結合時空圖神經網路（ST-GNN）處理空間依賴性。

